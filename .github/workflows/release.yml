name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release:
    # Skip if this is a release commit to prevent loops
    # Branch protection requires PRs, so this workflow creates a release branch + PR
    if: ${{ !contains(github.event.head_commit.message, 'chore(release):') }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry git-cliff

      - name: Determine last tag
        id: last_tag
        run: |
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$last_tag" >> $GITHUB_OUTPUT

      - name: Determine bump type
        id: bump
        run: |
          last_tag="${{ steps.last_tag.outputs.last_tag }}"
          range=""
          if [ -n "$last_tag" ]; then
            range="$last_tag..HEAD"
          else
            range="HEAD"
          fi
          body=$(git log $range --pretty=%B)
          echo "commit_range=$range" >> $GITHUB_OUTPUT
          if echo "$body" | grep -q -E 'BREAKING CHANGE|!:'
          then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$body" | grep -q '^feat'
          then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version (poetry)
        id: bump_version
        run: |
          pip install poetry
          current=$(poetry version -s)
          echo "current_version=$current" >> $GITHUB_OUTPUT
          echo "Current version: $current"
          bump=${{ steps.bump.outputs.bump }}
          echo "Bump type: $bump"
          case "$bump" in
            major) poetry version major ;;
            minor) poetry version minor ;;
            patch) poetry version patch ;;
            *) echo "Unknown bump: $bump"; exit 1 ;;
          esac
          newver=$(poetry version -s)
          echo "new_version=$newver" >> $GITHUB_OUTPUT
          echo "New version: $newver"

      - name: Update README version badge
        run: |
          newver="${{ steps.bump_version.outputs.new_version }}"
          sed -i.bak "s/version-[0-9]\+\.[0-9]\+\.[0-9]\+-blue/version-${newver}-blue/" README.md
          rm -f README.md.bak

      - name: Generate changelog (git-cliff)
        run: |
          pip install git-cliff
          git-cliff -o CHANGELOG.md

      - name: Create Pull Request
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            pyproject.toml
            CHANGELOG.md
            README.md
          commit-message: "chore(release): v${{ steps.bump_version.outputs.new_version }}"
          committer: "github-actions[bot] <actions@github.com>"
          author: "github-actions[bot] <actions@github.com>"
          branch: release/v${{ steps.bump_version.outputs.new_version }}
          delete-branch: true
          title: "chore(release): v${{ steps.bump_version.outputs.new_version }}"
          body: |
            Automated release PR for v${{ steps.bump_version.outputs.new_version }}.

            This PR updates:
            - `pyproject.toml` version bump (v${{ steps.bump_version.outputs.current_version }} â†’ v${{ steps.bump_version.outputs.new_version }})
            - `README.md` version badge updated
            - `CHANGELOG.md` generated changelog

            **Merge this PR to trigger tag creation and release publishing.**
          labels: release

      # Fallback: If PR creation fails (Actions blocked), create an issue
      - name: Create notification issue (if PR creation blocked)
        if: steps.create_pr.outputs.pull-request-number == ''
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.bump_version.outputs.new_version }}';
            const branch = `release/v${version}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Action Required] Manual PR needed for release v${version}`,
              body: `The release automation could not create a PR automatically.

              **Action needed:**
              The version has been bumped in the working tree but needs to be committed to a branch and PR'd.

              Please check the workflow logs and create a release PR manually if needed.

              Target version: v${version}`,
              labels: ['release', 'automation']
            });
