name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    # Skip if the triggering commit already contains [ci skip]
    if: ${{ !contains(github.event.head_commit.message, '[ci skip]') }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install poetry git-cliff

      - name: Determine last tag
        id: last_tag
        run: |
          last_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "last_tag=$last_tag" >> $GITHUB_OUTPUT

      - name: Determine bump type
        id: bump
        run: |
          last_tag="${{ steps.last_tag.outputs.last_tag }}"
          range=""
          if [ -n "$last_tag" ]; then
            range="$last_tag..HEAD"
          else
            range="HEAD"
          fi
          body=$(git log $range --pretty=%B)
          echo "commit_range=$range" >> $GITHUB_OUTPUT
          if echo "$body" | grep -q -E 'BREAKING CHANGE|!:'
          then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$body" | grep -q '^feat'
          then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version (poetry)
        id: bump_version
        run: |
          pip install poetry
          current=$(poetry version -s)
          echo "current_version=$current" >> $GITHUB_OUTPUT
          echo "Current version: $current"
          bump=${{ steps.bump.outputs.bump }}
          echo "Bump type: $bump"
          case "$bump" in
            major) poetry version major ;;
            minor) poetry version minor ;;
            patch) poetry version patch ;;
            *) echo "Unknown bump: $bump"; exit 1 ;;
          esac
          newver=$(poetry version -s)
          echo "new_version=$newver" >> $GITHUB_OUTPUT
          echo "New version: $newver"

      - name: Commit version bump
        env:
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add pyproject.toml
          if git diff --staged --quiet; then
            echo "No version change to commit"
          else
            git commit -m "chore(release): v${{ steps.bump_version.outputs.new_version }}" || true
          fi

      - name: Generate changelog (git-cliff)
        run: |
          pip install git-cliff
          git-cliff -o CHANGELOG.md
          if git status --porcelain | grep -q CHANGELOG.md; then
            git add CHANGELOG.md
            git commit -m "chore(changelog): update for v${{ steps.bump_version.outputs.new_version }}" || true
          else
            echo "No changelog changes"
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(release): v${{ steps.bump_version.outputs.new_version }}"
          committer: "github-actions[bot] <actions@github.com>"
          author: "github-actions[bot] <actions@github.com>"
          branch: release/v${{ steps.bump_version.outputs.new_version }}
          title: "chore(release): v${{ steps.bump_version.outputs.new_version }}"
          body: |
            Automated release PR for v${{ steps.bump_version.outputs.new_version }}.
            
            This PR updates:
            - `pyproject.toml` version bump
            - `CHANGELOG.md` generated changelog
            
            **Merge this PR to trigger tag creation and release publishing.**
          labels: release
          delete-branch: true
